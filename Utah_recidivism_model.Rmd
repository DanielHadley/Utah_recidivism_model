---
title: "Utah Recidivism Model"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load the packages neeed and set working directory
setwd("~/Github/Utah_recidivism_model/")
library(dplyr)
library(ggplot2)
library(printr)
library(knitr)
```

## About This Model
The following code is to analyze data and make ballpark predictions about how much a reduction in recidivism could potentially save the State of Utah. We are specifically interested in parolees with co-occuring disorders (COD). As the statistician George Box [famously observed](https://en.wikipedia.org/wiki/All_models_are_wrong), 

> All models are wrong but some are useful.

I hope this one is useful. 


### Assumptions
The greatest challenge in making predictions about the costs and benefits of the COD population is that the Justice Reinvestment Initiative (JRI) is old enough to affect outcomes in areas like recidivism, prison terms, crime frequencies, and parole sentences, but not old enough to collect reliable data on those effects. Therefore, I am forced to make several assumptions about the likely effects of the JRI on these outcomes. I will try to list some of the important ones below, but there are other assumptions throughout this notebook.       


```{r}
# A 10% reduction in recidivism 
recid_reduction_JRI <- .10

# One big change is that offenders can get what's called earned time credits while incarcerated, 
# which can also impact their length of stay (reduce it).
# A 20% reduction in mean time served seems reasonable
time_served_scale_JRI <- .8

# Another big change from the JRI is that prison sentences for technical violations are capped
# So we change the 15-month mean time served to a 2-month one
# page 39: http://www.utah.gov/pmn/files/172049.pdf
parole_violation_MTS_JRI <- 2

# Finally, the length of parole is expected to go down significantly
# AS far as I can tell, 3 years was standard for all offenders. 
# http://law.justia.com/codes/utah/2006/title76/76_03009.html
# With the JRI, parolees with good behavior can reduce that to 18 months
parole_length_JRI <- 18
```


## About the data
The two main datasets that inform this model are, 

* Prison Terms, which contain crime frequencies, their estimated average prison sentence, and an estimate of the direct taxpayer costs associated with that crime

* Survival Rates, which are the kaplan-meier curves from national data, extrapolated to fit Utah's trends 

### Prison Terms
I pieced this data together using a an email from Julie Christensen, which contained the offense frequencies for our COD demographic, and various reports from the CCJJ. For the "frequency" column, I took the `frequency_of_crime` and added parole violations, which used to account for 70% of returns. In the model, `frequency` is used when the person is on parole, and `frequency_of_crime` is used when they are not. The [Justice Reinvestment Report](http://justice.utah.gov/Documents/CCJJ/Reports/Justice_Reinvestment_Report_2014.pdf) and [ACLU Report](http://www.acluutah.org/criminal-justice/item/download/15_0cfccf37c91e9fb16be4ac2e89ca12f2) contain the mean time served for various offenses, which I scale down 20% to reflect changes from the JRI (as described above). Finally, the [Cost of Crime Report](http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf) contains estimates of the taxpayer costs for most categories (extrapolated for parole violations).    


```{r}
prison_terms <- read.csv("./clean_data/prison_terms.csv", stringsAsFactors = FALSE) %>% 
  mutate(mean_time_served = round(mean_time_served)) %>% 
  select(-assumptions)

# I do these so that I can add a blank in the function below
prison_terms[8,1] <- ""

# replcace NAs with 0
prison_terms$frequency[is.na(prison_terms$frequency)] <- 0
prison_terms$frequency_of_crime[is.na(prison_terms$frequency_of_crime)] <- 0

# Scale down time served to reflect (guess)timated effects of the JRI
prison_terms$mean_time_served <- prison_terms$mean_time_served * time_served_scale_JRI

# Change parole violation sentences to post-JRI level
prison_terms$mean_time_served[prison_terms$offense_type == "Parole_Violation"] <- parole_violation_MTS_JRI

# Pretty printing
kable(head(prison_terms, 10), digits = 3)
```


### Survival Rates
The kaplan-meier curves come from this [BJS Report](http://www.bjs.gov/index.cfm?ty=pbdetail&iid=4986) of national trends. I do not have clean data showing the exact Utah curves (nor does such data exist for the post-JRI era), but I was encouraged to learn that the 3-year outcomes for Utah pre-JRI were very similar to national trends. Threfore, I assume similar curves, and simply increase the recidivism rates to better reflect our COD demographic, and then decrease them in an attempt to reflect the COD demographic post JRI. In all likliehood the actual curves for the post-JRI period will be different; but these provide decent estimates.  


```{r survival, include=FALSE}
## Load and clean the data ##
# These are the national data
survival_rates <- read.csv("./clean_data/mschpprts05f02.csv", 
                           stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state = as.numeric(X.1),
         cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)


# Here are imputed survival rates. Basically, the data that Julie sent suggest that the national trends for recidivism are very similar to the Utah trends (or at least they were between 2012 and 2015).
# The data also show that our study group had a recidivsm rate that was 74.3% after 36 months, whereas all prisoners had a rate of 64.2% (again, close to natural). The difference between the control group and national trends is (74.3 - 64.2) / 64.2, OR:
COD_group_increase = 0.157

sr_study_group <- read.csv("./clean_data/mschpprts05f02.csv", 
                                 stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state = as.numeric(X.1),
         In.state = In.state + (In.state * COD_group_increase)) %>% 
  mutate(cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)


# Let's see what will happen post JRI
COD_group_increase = 0.157
recid_reduction = recid_reduction_JRI

sr_post_intervention <- read.csv("./clean_data/mschpprts05f02.csv", 
                           stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state_pre = as.numeric(X.1),
         In.state_pre = In.state_pre + (In.state_pre * COD_group_increase),
         In.state = In.state_pre - (In.state_pre * recid_reduction)) %>% 
  mutate(cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)

sr_post_intervention$cum_per_of_reoffenders <- sr_post_intervention$In.state / sr_post_intervention$In.state[60]



# Put them together to plot

all_together <- data.frame(sr_post_intervention$cumulative_percent, sr_study_group$cumulative_percent, survival_rates$cumulative_percent)

all_together$months <- c(1:60)
```


```{r pressure, echo=FALSE}
# plot the curves
ggplot(all_together, aes(months)) + 
  geom_line(aes(y = sr_post_intervention.cumulative_percent, colour = "COD Post-JRI")) + 
  geom_line(aes(y = sr_study_group.cumulative_percent, colour = "COD Group")) +
  geom_line(aes(y = survival_rates.cumulative_percent, colour = "National Trend")) +
  ylab("Cumulative Probability of Recidivism")

# And clean things up
rm(all_together, sr_post_intervention, sr_study_group, survival_rates)
```


## A Stochastic Agent-based Model
Although this does not have all of the features commonly associated with an [agent-based model](https://en.wikipedia.org/wiki/Agent-based_model), I use this term to describe the two-pronged process followed below: 

1. Simulate a single agent for five years from the time he or she leaves prison. Each agent may return to prison immediately, or stay out of prison for the entire 60 months. The odds of these events are based on real data and are stochastic in the sense that they are not predetermined.   
2. Repeat this simulation thousands of times to see how the results vary.


### Using Real Data to Simulate Recidivism

The first step in this process is to turn data from the survival curves into an estimate of a parolee's odds of recidivating in a given month, e.g., `P(relapse|months free)`. To do that, I wrote a function that first defines the correct survival curve, and then transforms the data from the cumulative probabilty of being arrested *by* time period (t), to the individual probabilty of being arrested *in* period (t).  


```{r}
# Load survival data: the single argument is for reducing recidivism to model some intervention
load_survival_data <- function(recid_reduction_ovr_cntrl){
  
  # This is the increased rate of recidivism of our COD group, relative to national
  COD_group_increase = 0.157
  
  survival_rates <- read.csv("./clean_data/mschpprts05f02.csv", 
                             stringsAsFactors = F) %>% 
    filter(X != "",
           X != "National") %>% 
    mutate(In.state = as.numeric(X.1),
           
           # Increase from COD group
           In.state = In.state + (In.state * COD_group_increase),
           
           # Minus the JRI reduction
           # This is defined in the assumptions section above
           In.state = In.state - (In.state * recid_reduction_JRI),
           
           # If we expect further reductions from targeted intervention
           In.state = In.state - (In.state * recid_reduction_ovr_cntrl)) %>% 
    
    # Now turn the data into P(relapse | t)
    mutate(cumulative_percent = In.state / 100,
           cumulative_prob_did_not = 1 - cumulative_percent,
           prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not),
           prob_did_not_recidivate = 1 - prob_recidivate) %>% 
    filter(In.state != 0) %>% 
    select(prob_recidivate, prob_did_not_recidivate)
}
```


When loaded with no treatment assumed, the first five rows of data look like this:

```{r, echo=FALSE}
survival_rates <- load_survival_data(0)
kable(head(survival_rates, 5), digits = 3)
```

These estimates show that in the first month, someone from the COD group has about a 8% chance of recidivating. But if he can make it 4 months, that drops to only 5% in month 5. Using these data, we are now ready to populate our model.


### Functions needed for the model 

This section is where all of the calculations take place. I'm putting it all in to make peer review easier, but if you are not interested in how the sausage gets made, I reccomend skipping to the "Results" section. These functions all take as arguments variables like `months_free` and `prison_sentence`, and return variables like `marginal_cost_of_parole`. All of the helper functions are run each "month" of the agent-level model. 


```{r the functions}
# If the agent is free, how many months has he or she been free
calc_months_free <- function(m.month, m.prison_sentence, tmp.months_free) {
  ifelse(m.month == 1, 1,
         ifelse(m.prison_sentence > 1, 0,
                tmp.months_free + 1))
}


# Taking the survival analysis data from national trends, this will calculate the odds of being rearrested conditional on the number of months he or she has been free
calc_odds_of_being_rearrested <- function(m.months_free) {
  ifelse(m.months_free == 0, 0,
         sample(x = c(1, 0), 
                size = 1, 
                replace = FALSE, 
                prob = c(as.matrix(survival_rates[m.months_free,]))))
}


# If arrested what is the prison sentence? This samples from the crime frequencies and returns a sentence based on the selected crime.
define_crime_and_time <- function(tmp.is_on_parole, m.rearrested_or_not, m.month, tmp.prison_sentence) {
  
  # First the index of crime and time, based on a probabilistic sample of crime types
  # It's a little ineffecient to do this every time, but NBD
  if_on_parole <- sample(x = c(1:nrow(prison_terms)),
                        size = 1,
                        replace = FALSE,
                        prob = c(prison_terms$frequency))
  
  # By definition, if they are off parole they can only be arrested for a crime
  if_off_parole <- sample(x = c(1:nrow(prison_terms)),
                          size = 1,
                          replace = FALSE,
                          prob = c(prison_terms$frequency_of_crime))
  
  # There is a one month lag b/c I am using the tmp.is_on_parole, but that is acceptble
  crime_index <- ifelse(m.month == 1, if_on_parole,
                        ifelse(tmp.is_on_parole == 1, if_on_parole,
                               if_off_parole))
  
  # The crime
  crime <- if_else(m.rearrested_or_not == 1, 
                   prison_terms$offense_type[crime_index],
                   "")
  
  # Sentence, aka, the time
  prison_sentence <- if_else(m.rearrested_or_not == 1, 
                             as.numeric(prison_terms$mean_time_served[crime_index]),
                             ifelse(m.month == 1, 0,
                                    ifelse(m.rearrested_or_not == 0, 
                                           tmp.prison_sentence, 
                                           0)))
  
  to_return <- list(crime, prison_sentence)
  
  return(to_return)
}


# Simply for summing later and helping with cost functions below
say_if_in_prison <- function(m.prison_sentence) {
  ifelse(m.prison_sentence > 0, 1, 0)
}


# Parole (under JRI)
# The reason this is not longer than 18 is that if they have made it this long without reoffending, they are by definition showing good behavior 
calc_parole_sentence <- function(m.month, m.rearrested_or_not, tmp.parole_sentence){
  ifelse(m.month == 1, parole_length_JRI,
         ifelse(m.rearrested_or_not == 1, parole_length_JRI,
                tmp.parole_sentence))
}


## The monthly costs of prison
# Marginal
calc_marginal_prison_costs <- function(m.is_in_prison, m.month) {
  
  # My calculation of the marginal costs
  # See Analyze_Costs.R
  marginal_cost_of_prison <- 5200 / 12
  
  # Marginal long term
  marginal_cost_of_prison_lt <- 16376 / 12
  
  if_else(m.is_in_prison == 1 & m.month <= 36, marginal_cost_of_prison, 
          ifelse(m.is_in_prison == 1 & m.month > 36, marginal_cost_of_prison_lt,
                 0))
}


# Total
# From the CPD data
calc_total_prison_costs <- function(m.is_in_prison) {
  
  total_cost_of_prison <- 30000 / 12
  
  if_else(m.is_in_prison == 1, total_cost_of_prison, 
          0)
}


### The costs of crime
# http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf
# courts
calc_total_court_costs <- function(m.rearrested_or_not, m.crime_type){
  
  ifelse(m.rearrested_or_not == 1, 
         prison_terms$court_cost[prison_terms$offense_type == m.crime_type],
         0)
  
}


# cops
calc_total_policing_costs <- function(m.rearrested_or_not, m.crime_type){
  
  ifelse(m.rearrested_or_not == 1, 
         prison_terms$police_cost[prison_terms$offense_type == m.crime_type],
         0)
  
}


# IF out of prison, in a shelter???
# Not sure how to think of this.
# Low end estimate: 386 out of 17,039 on parole or probation are in CCCs (2.2%)
# High end estimate: the frequent users in DC spent 25% in a shelter.
# Medium but conservative: "In CA, 10% of stateâ€™s parolees are homeless"
# http://www.urban.org/sites/default/files/alfresco/publication-pdfs/412504-Frequent-Users-of-Jail-and-Shelter-Systems-in-the-District-of-Columbia-An-Overview-of-the-Potential-for-Supportive-Housing.PDF
# http://www.endhomelessness.org/page/-/files/1101_file_Cho_Presentation.pdf
define_shelter_days <- function(m.is_in_prison){
  
  ifelse(m.is_in_prison == 1, 0,
         sample(x = (c(1,0)), 1, prob = c(.1, .9)))
  
}


# When they are on parole, most will not go to a homeless shelter, but rather a CCC
# The cost to operate those are in the CPD data from AP&P. 
# There are a lot of possibilities for calculating the costs when they are off parole. Yvette sent data on Palmer Court and other shelters. Julia sent some data on the cost to operate and number of folks in halfway houses. There is a huge variety in costs. I think Yvette's estimate is a good place to start, which is 10.10. 
calc_shelter_costs <- function(m.is_in_shelter, m.is_on_parole){
  
  shelter_cost <- 10.10
  CCC_cost <- mean(54, 102, 75, 143, 95)
  
  ifelse(m.is_in_shelter == 1 & m.is_on_parole == 0, shelter_cost * 30.5,
         ifelse(m.is_in_shelter == 1 & m.is_on_parole == 1, CCC_cost * 30.5,
         0))
  
}


# Adult parole costs (this group will not get probation)
# This data comes from the cost per day pdf given to me
calc_total_app_costs <- function(m.is_on_parole){
  
  # Based on the cost per day data
  # But minus the shelter,i.e., CCCs, because those are only used by a portion
  
  cost_per_day <- (.23 + .62 + .51) + #admin costs
    mean(7.06, 6.5, 5.48, 8.34, 6.13) + # Avg of Region costs
    .5 # community programs
    
  
  ifelse(m.is_on_parole == 1, cost_per_day * 30.5, 0)
  
}


# DWS & DHS
# average costs for DWS - food stamps, abd, WIOA, etc - are 75$ for adult males in the program
# It's probably safe to assume that the average COD parolee uses that
# DHS spends an average of $3000 per client on Substance use and $3000 per client on Mental Health, including inpatient, outpatient, crisis care, etc.
# Probably safe to assume there is some overlap here, but not total overlap. Conservatively, we will say $3000 total per parolee / yr, and hope that will make up for the fact that some probably do not use it at all. 
calc_total_DWS_DHS_costs <- function(m.is_in_prison){
  
  DWS <- 75
  DHS <- 3000 / 12
  
  ifelse(m.is_in_prison == 0, DHS + DWS, 0)
  
}

```


#### Single-agent function
This is basically a for loop that iterates through the months of a 5-year timeframe and calculates costs and activities based on whether the parolee is in prison or free.

```{r single agent}
sim_single_agent <- function(months) {
  
  # Define some factors
  levels.crimetype <- factor(prison_terms$offense_type)
  
  # set up the data frame
  df <- data.frame(month=numeric(0),
                   months_free=numeric(0),
                   rearrested_or_not=numeric(0),
                   prison_sentence=numeric(0),
                   crime_type=factor(levels = levels.crimetype),
                   is_in_prison=numeric(0),
                   is_on_parole=numeric(0),
                   parole_sentence=numeric(0),
                   marginal_prison_costs=numeric(0),
                   total_prison_costs=numeric(0),
                   total_court_costs=numeric(0),
                   total_policing_costs=numeric(0),
                   is_in_shelter=numeric(0),
                   total_shelter_costs=numeric(0),
                   total_parole_costs=numeric(0),
                   total_DWS_DHS_costs=numeric(0))
  
  # loop through each month and see what happens			
  for (month in 1:months) {
    
    ### generate action for each month ###
    m.month <- month
    
    # Dependent on whether they were arrested or not
    m.months_free <- calc_months_free(m.month, m.prison_sentence, tmp.months_free)
    
    # Binary variable based on the conditional probability table from nationwide trends
    m.rearrested_or_not <- calc_odds_of_being_rearrested(m.months_free)
  
    
    # Add a crime and prison sentence if there was an arrest
    # Also based on probability table from national trends
    crime_and_time <- 
      define_crime_and_time(m.is_on_parole, m.rearrested_or_not, m.month, tmp.prison_sentence)
    
    m.prison_sentence <- as.numeric(crime_and_time[2])
    
    m.crime_type <- as.character(crime_and_time[1])
  
    
    # For calculating the total months in prison later
    m.is_in_prison <- say_if_in_prison(m.prison_sentence)
    
    # And a parole sentence for when they get out
    m.parole_sentence <- calc_parole_sentence(m.month, m.rearrested_or_not, tmp.parole_sentence)
    
    # Is on parole??
    m.is_on_parole <- if_else(m.is_in_prison == 1, 0,
                              ifelse(m.months_free <= m.parole_sentence, 1, 0))
    
    ### Costs of crimes commited
    # Prison
    m.marginal_prison_costs <- calc_marginal_prison_costs(m.is_in_prison, m.month)
    m.total_prison_costs <- calc_total_prison_costs(m.is_in_prison)
    
    # Courts
    m.total_court_costs <- calc_total_court_costs(m.rearrested_or_not, m.crime_type)
    
    # Cops
    m.total_policing_costs <- calc_total_policing_costs(m.rearrested_or_not, m.crime_type)
    
    # Shelters 
    m.is_in_shelter <- define_shelter_days(m.is_in_prison)
    m.total_shelter_costs <- calc_shelter_costs(m.is_in_shelter, m.is_on_parole)
    
    # Parole
    m.total_parole_costs <- calc_total_app_costs(m.is_on_parole)
    
    # DWS
    m.total_DWS_DHS_costs <- calc_total_DWS_DHS_costs(m.is_in_prison)
    
    
    # add month to the data frame
    df[month,] <- 
      c(m.month, m.months_free, m.rearrested_or_not, m.prison_sentence, 
        m.crime_type, m.is_in_prison, m.is_on_parole, m.parole_sentence, 
        m.marginal_prison_costs, m.total_prison_costs, m.total_court_costs, 
        m.total_policing_costs, m.is_in_shelter, m.total_shelter_costs, 
        m.total_parole_costs, m.total_DWS_DHS_costs)
    
    
    # Make temporary vector for determining months free in the next pass
    tmp.months_free <- if_else(m.rearrested_or_not == 1, 0, m.months_free)
    
    # Temporary parole sentence
    tmp.parole_sentence <- m.parole_sentence
    tmp.is_on_parole <- m.is_on_parole
    
    # Also, count down the time served from last month, if any
    tmp.prison_sentence <- ifelse(m.prison_sentence == 0, 0,
                                  m.prison_sentence - 1)
  }
  
  # output results
  return (df)
}
```


When run for a single person, the rows and columns look like this (although the actual values will vary randomly based on the underlying data):

```{r, echo=FALSE}
single_agent_test <- sim_single_agent(60)
kable(head(single_agent_test, 12), digits = 3)
```


#### Multi-agent function
This runs the single-agent simulation N times and compiles the results. 

```{r}
sim_multi_agents <- function(n_agents, n_months){
  
  # set up the data frame
  df <- data.frame(prison_time=numeric(0),
                   months_free=numeric(0),
                   prison_costs=numeric(0),
                   arrests=numeric(0),
                   total_costs=numeric(0),
                   avg_total_cost_per_yr=numeric(0))
  
  # loop through each month and see what happens			
  for (agent in 1:n_agents) {
    
    ### generate action for each person ###
    single_agent <- sim_single_agent(n_months)
    
    # Sum things that happend to the agent
    a.prison_time <- sum(as.numeric(single_agent$is_in_prison))
    a.months_free <- 60 - a.prison_time
    a.total_prison_costs <- sum(as.numeric(single_agent$total_prison_costs))
    a.arrests <- sum(as.numeric(single_agent$rearrested_or_not))
    
    # Get total costs
    total_costs <- single_agent %>% 
      select(starts_with("total"))
    
    total_costs <- sapply(total_costs, as.numeric)
    a.total_costs <- sum(colSums(total_costs))
    
    a.avg_total_cost_per_yr <- a.total_costs / (n_months / 12)
    
    
    # add month to the data frame
    df[agent,] <- 
      c(a.prison_time, a.months_free, a.total_prison_costs, a.arrests, a.total_costs,
        a.avg_total_cost_per_yr)
    
  }
  
  # output results
  return (df)
  
}
```

When run for a period of 5 years with 1,000 agents, the first few rows look like this (again, with data that varies based on the results of the individual simulations):

```{r, echo=FALSE}
multi_agent_test <- sim_multi_agents(n_agents = 1000, n_months = 60)
kable(head(multi_agent_test, 10), digits = 3)
```
