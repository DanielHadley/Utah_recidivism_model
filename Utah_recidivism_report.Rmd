---
title: "The Benefits of Reducing Recidivsm in Utah"
output:
  word_document:
    reference_docx: mystyles.docx
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)

set.seed(123)

# Load the packages neeed and set working directory
setwd("~/Github/Utah_recidivism_model/")
library(tidyverse)
library(printr)
library(knitr)
library(scales)
library(VGAM) #Pareto distribution

# Notice that I have a reference doc, mystyles. I used this to create a page break after H5 tags, per this doc: 
# scriptsandstatistics.wordpress.com/2015/12/18/rmarkdown-how-to-inserts-page-breaks-in-a-ms-word-document/
```


```{r lit review, echo=FALSE}
# # literature review
# 
# http://archive.vera.org/sites/default/files/resources/downloads/marginal-costs-guide.pdf
# 
# http://www.criminaljustice.ny.gov/crimnet/ojsa/resultsfirst/rf-technical_report_cba1_oct2013.pdf
# 
# http://www.policyinnovationlab.org/wp-content/uploads/2016/06/Missoula-County-Montana-Final-PFS-Report.pdf
# 
# http://nij.gov/journals/272/pages/cost-benefit.aspx
# 
# https://www.jstor.org/stable/29766578?seq=19#page_scan_tab_contents
# 
# https://www.vera.org/publications/the-price-of-prisons-what-incarceration-costs-taxpayers
# 
# http://www.urban.org/sites/default/files/alfresco/publication-pdfs/412504-Frequent-Users-of-Jail-and-Shelter-Systems-in-the-District-of-Columbia-An-Overview-of-the-Potential-for-Supportive-Housing.PDF
# 
# http://www.endhomelessness.org/page/-/files/1101_file_Cho_Presentation.pdf
# 
# https://works.bepress.com/dennis_culhane/4/
# 
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3840153/
#   
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1497852/
# 
# http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf
# 
# http://bjs.gov/content/pub/pdf/tssp.pdf
# 
# http://scholarlycommons.law.northwestern.edu/cgi/viewcontent.cgi?article=6051&context=jclc
# 
# http://www.utah.gov/pmn/files/172049.pdf
#  
# http://law.justia.com/codes/utah/2006/title76/76_03009.html
# 
# http://corrections.utah.gov/index.php?option=com_content&view=category&id=31&Itemid=344
# 
#  http://www.deseretnews.com/article/705273784/Many-Utahns-refuse-to-ride-in-ambulance.html?pg=all
# 
#  http://blog.bcbsnc.com/2014/04/5-emergency-room-myths-busted/
```



```{r plot rates, echo=FALSE}
# A 10% reduction in recidivism 
recid_reduction_JRI <- .10

## Load and clean the data ##
# These are the national data
sr_baseline <- read.csv("./clean_data/mschpprts05f02.csv", 
                           stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state = as.numeric(X.1),
         cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)


# Here are imputed survival rates. Basically, the data that Julie sent suggest that the national trends for recidivism are very similar to the Utah trends (or at least they were between 2012 and 2015).
# The data also show that our study group had a recidivsm rate that was 74.3% after 36 months, whereas all prisoners had a rate of 64.2% (again, close to natural). The difference between the control group and national trends is (74.3 - 64.2) / 64.2, OR:
COD_group_increase = 0.157

sr_study_group <- read.csv("./clean_data/mschpprts05f02.csv", 
                                 stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state = as.numeric(X.1),
         In.state = In.state + (In.state * COD_group_increase)) %>% 
  mutate(cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)


# Let's see what will happen post JRI
COD_group_increase = 0.157

sr_post_intervention <- read.csv("./clean_data/mschpprts05f02.csv", 
                           stringsAsFactors = F) %>% 
  filter(X != "",
         X != "National") %>% 
  mutate(In.state_pre = as.numeric(X.1),
         In.state_pre = In.state_pre + (In.state_pre * COD_group_increase),
         In.state = In.state_pre - (In.state_pre * recid_reduction_JRI)) %>% 
  mutate(cumulative_percent = In.state / 100,
         cumulative_prob_did_not = 1 - cumulative_percent,
         prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not)) %>% filter(In.state != 0)

sr_post_intervention$cum_per_of_reoffenders <- sr_post_intervention$In.state / sr_post_intervention$In.state[60]



# Put them together to plot

all_together <- data.frame(sr_post_intervention$cumulative_percent, sr_study_group$cumulative_percent, sr_baseline$cumulative_percent)

all_together$months <- c(1:60)

```




```{r prison terms, echo=FALSE}
prison_terms <- read.csv("./clean_data/prison_terms.csv", stringsAsFactors = FALSE) %>% 
  mutate(mean_time_served = round(mean_time_served)) %>% 
  select(-assumptions)

# I do these so that I can add a blank in the function below
prison_terms[8,1] <- ""

# replcace NAs with 0
prison_terms$frequency[is.na(prison_terms$frequency)] <- 0
prison_terms$frequency_of_crime[is.na(prison_terms$frequency_of_crime)] <- 0

# Update Cost of Crime numbers from constant 2010 dollars to 2016
# This is the calculator: http://www.usinflationcalculator.com/
prison_terms$court_cost <- prison_terms$court_cost * 1.1
prison_terms$police_cost <- prison_terms$police_cost * 1.1

```




```{r jri changes, echo=FALSE}

# This is just a guess
time_served_scale_JRI <- .8

# Scale down time served to reflect (guess)timated effects of the JRI
prison_terms$mean_time_served_post_JRI <- round(prison_terms$mean_time_served * time_served_scale_JRI)


# Another big change from the JRI is that prison sentences for technical violations are capped
# So we change the 15-month mean time served to a 2-month one
# page 39: http://www.utah.gov/pmn/files/172049.pdf
parole_violation_MTS_JRI <- 2

# Change parole violation sentences to post-JRI level
prison_terms$mean_time_served_post_JRI[prison_terms$offense_type == "Parole_Violation"] <- parole_violation_MTS_JRI

# Finally, the length of parole is expected to go down significantly
# AS far as I can tell, 3 years was standard for all offenders. 
# http://law.justia.com/codes/utah/2006/title76/76_03009.html
# With the JRI, parolees with good behavior can reduce that by 8 months
# http://corrections.utah.gov/index.php?option=com_content&view=category&id=31&Itemid=344
parole_length_JRI <- 28

```




```{r the functions, echo=FALSE}
### These are the basis of the model, and also contain several assumptions

# If the agent is free, how many months has he or she been free
calc_months_free <- function(m.month, m.prison_sentence, tmp.months_free) {
  ifelse(m.month == 1, 1,
         ifelse(m.prison_sentence > 1, 0,
                tmp.months_free + 1))
}


# Taking the survival analysis data from national trends, this will calculate the odds of being rearrested conditional on the number of months he or she has been free
calc_odds_of_being_rearrested <- function(m.months_free) {
  ifelse(m.months_free == 0, 0,
         sample(x = c(1, 0), 
                size = 1, 
                replace = FALSE, 
                prob = c(as.matrix(survival_rates[m.months_free,]))))
}


# If arrested what is the prison sentence? This samples from the crime frequencies and returns a sentence based on the selected crime.
define_crime_and_time <- function(tmp.is_on_parole, m.rearrested_or_not, m.month, tmp.prison_sentence) {
  
  # First the index of crime and time, based on a probabilistic sample of crime types
  # It's a little ineffecient to do this every time, but NBD
  if_on_parole <- sample(x = c(1:nrow(prison_terms)),
                        size = 1,
                        replace = FALSE,
                        prob = c(prison_terms$frequency))
  
  # By definition, if they are off parole they can only be arrested for a crime
  if_off_parole <- sample(x = c(1:nrow(prison_terms)),
                          size = 1,
                          replace = FALSE,
                          prob = c(prison_terms$frequency_of_crime))
  
  # There is a one month lag b/c I am using the tmp.is_on_parole, but that is acceptble
  crime_index <- ifelse(m.month == 1, if_on_parole,
                        ifelse(tmp.is_on_parole == 1, if_on_parole,
                               if_off_parole))
  
  # The crime
  crime <- if_else(m.rearrested_or_not == 1, 
                   prison_terms$offense_type[crime_index],
                   "")
  
  # Sentence, aka, the time
  prison_sentence <- if_else(m.rearrested_or_not == 1, 
                             as.numeric(prison_terms$mean_time_served_post_JRI[crime_index]),
                             ifelse(m.month == 1, 0,
                                    ifelse(m.rearrested_or_not == 0, 
                                           tmp.prison_sentence, 
                                           0)))
  
  to_return <- list(crime, prison_sentence)
  
  return(to_return)
}


# Simply for summing later and helping with cost functions below
say_if_in_prison <- function(m.prison_sentence) {
  ifelse(m.prison_sentence > 0, 1, 0)
}


# Parole (under JRI)
# The reason this is not longer than 18 is that if they have made it this long without reoffending, they are by definition showing good behavior 
calc_parole_sentence <- function(m.month, m.rearrested_or_not, tmp.parole_sentence){
  ifelse(m.month == 1, parole_length_JRI,
         ifelse(m.rearrested_or_not == 1, parole_length_JRI,
                tmp.parole_sentence))
}


## The monthly costs of prison
# Marginal
calc_marginal_prison_costs <- function(m.is_in_prison, m.month) {
  
  # My calculation of the marginal costs
  # See Analyze_Costs.R
  marginal_cost_of_prison <- 5200 / 12
  
  # Marginal long term
  marginal_cost_of_prison_lt <- 16376 / 12
  
  if_else(m.is_in_prison == 1 & m.month <= 36, marginal_cost_of_prison, 
          ifelse(m.is_in_prison == 1 & m.month > 36, marginal_cost_of_prison_lt,
                 0))
}


# Total
# From the CPD data
calc_total_prison_costs <- function(m.is_in_prison) {
  
  total_cost_of_prison <- 30000 / 12
  
  if_else(m.is_in_prison == 1, total_cost_of_prison, 
          0)
}


### The costs of crime
# http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf
# courts
calc_total_court_costs <- function(m.rearrested_or_not, m.crime_type){
  
  ifelse(m.rearrested_or_not == 1, 
         prison_terms$court_cost[prison_terms$offense_type == m.crime_type],
         0)
  
}


# cops
calc_total_policing_costs <- function(m.rearrested_or_not, m.crime_type){
  
  ifelse(m.rearrested_or_not == 1, 
         prison_terms$police_cost[prison_terms$offense_type == m.crime_type],
         0)
  
}


### Parole Costs ###
# Adult parole costs (this group will not get probation)
# This data comes from the cost per day pdf given to me
calc_total_app_costs <- function(m.is_on_parole){
  
  # Based on the cost per day data
  # But minus the shelter,i.e., CCCs, because those are only used by a portion
  
  cost_per_day <- (.23 + .62 + .51) + #admin costs
    mean(7.06, 6.5, 5.48, 8.34, 6.13) + # Avg of Region costs
    .5 # community programs
    
  
  ifelse(m.is_on_parole == 1, cost_per_day * 30.5, 0)
  
}


### Other out-of-prison costs
#Represents the combined costs of DHS, DWS, Shelters, And Er Visits.
## First we will get averages for everything, then build a distribution

# Shelter
# When they are on parole, most will not go to a homeless shelter, but rather a CCC
# The cost to operate those are in the CPD data from AP&P. 
# There are a lot of possibilities for calculating the costs when they are off parole. Yvette sent data on Palmer Court and other shelters. Julia sent some data on the cost to operate and number of folks in halfway houses. There is a huge variety in costs. I think Yvette's estimate is a good place to start, which is 10.10 /night. 
# IF out of prison, in a shelter???
# Not sure how to think of this.
# Low end estimate: 386 out of 17,039 on parole or probation are in CCCs (2.2%)
# High end estimate: the frequent users in DC spent 25% in a shelter.
# Medium but conservative: "In CA, 10% of state’s parolees are homeless"
# http://www.urban.org/sites/default/files/alfresco/publication-pdfs/412504-Frequent-Users-of-Jail-and-Shelter-Systems-in-the-District-of-Columbia-An-Overview-of-the-Potential-for-Supportive-Housing.PDF
# http://www.endhomelessness.org/page/-/files/1101_file_Cho_Presentation.pdf
prob_of_shelter <- .1
monthly_shelter_cost <- 10 * prob_of_shelter * 30.5

# DWS
# average costs for DWS - food stamps, abd, WIOA, etc - are 75$ for adult males in the program
# It's probably safe to assume that the average COD parolee uses that
monthly_DWS_cost <- 75

# DHS
# DHS spends an average of $3000 per client on Substance use and $3000 per client on Mental Health, including inpatient, outpatient, crisis care, etc *for clients using those services*
# Julie and Brenda provided data on 197 parolees checked against the DHS database
# I found that approximately 33% used DHS services within one year of release, at an average rate of $1,400 (per year, I believe, although the data are not crystal clear)
# The average had a huge right tail, with a max payment of around $80k, hence the pareto distribution below
# We will adjust up slightly in case of missingness in the client match
monthly_DHS_cost <- 1500 / 12

# Emergency room
# average 2 visits per year, while out of prison, seems reasonable
# ambulance costs: http://www.deseretnews.com/article/705273784/Many-Utahns-refuse-to-ride-in-ambulance.html?pg=all
# Emergency room : http://blog.bcbsnc.com/2014/04/5-emergency-room-myths-busted/
prob_of_ER_visit <- 2 / 12  # two per year - your chance per month
ambulance <- 1200
ER <- 1200
monthly_ER_cost <- prob_of_ER_visit * (ambulance + ER)

# Finally, to be careful we will add in health care costs that are not related to ER visits or covered by the DHS costs.
# According to this report, prisoners in Utah cost about $4,400 per capita on health spending *while in prison*
# http://www.pewtrusts.org/~/media/assets/2014/07/stateprisonhealthcarespendingreport.pdf
# This would probably include some of the costs above (ER and DHS-type services)
# Some are bound to use private insurance and medicaid after, reducing per-capita costs
# But the COD group is also probably above average in terms of its use
# Considering all of this, I will add the following in non-duplicated "other" health costs
monthly_other_health_costs <- 2000 / 12

# Average out of prison
monthly_average_OUP_cost <- monthly_ER_cost + monthly_DWS_cost + monthly_shelter_cost + monthly_DWS_cost + monthly_DHS_cost + monthly_other_health_costs


#### This ultimately defines the costs for those out of prison (minus parole costs)
# We did not like that everything eas averaged for this group
# So we came up with a distribution based on the monthly average + estimated outliers
# These outliers are the super-utilizers, rare but important to count
# Old ones:
# unif_Base<-c(rgeom(58500,.0019),runif(1500,4000,35000))
# unif_Base <- rexp(6000, .0012)
# unif_Low<-c(rgeom(58575,.0019),runif(1425,4000,33250))
# unif_Med<-c(rgeom(57225,.002),runif(1275,4000,29750))
# unif_High<-c(rgeom(58875,.0021),runif(1125,4000,26250))
# New ones:
unif_Base <- rtruncpareto(n = 6000, lower = 25, upper = 12000, shape = .34)
unif_Low <- rtruncpareto(n = 6000, lower = 25, upper = 11000, shape = .38)
unif_Med <- rtruncpareto(n = 6000, lower = 25, upper = 10000, shape = .41)
unif_High <- rtruncpareto(n = 6000, lower = 25, upper = 8000, shape = .44)
calc_combined_cost<-function(parole_cost_type){
  switch (parole_cost_type,
    base = return(sample(unif_Base,1)),
    low = return(sample(unif_Low,1)),
    med = return(sample(unif_Med,1)),
    high= return(sample(unif_High,1))
  )
}

```




```{r survival data, echo=FALSE}
# Load survival data: the single argument is for reducing recidivism to model some intervention
load_survival_data <- function(recid_reduction_ovr_cntrl){
  
  # This is the increased rate of recidivism of our COD group, relative to national
  COD_group_increase = 0.157
  
  survival_rates <- read.csv("./clean_data/mschpprts05f02.csv", 
                             stringsAsFactors = F) %>% 
    filter(X != "",
           X != "National") %>% 
    mutate(In.state = as.numeric(X.1),
           
           # Increase from COD group
           In.state = In.state + (In.state * COD_group_increase),
           
           # Minus the JRI reduction
           # This is defined in the assumptions section above
           In.state = In.state - (In.state * recid_reduction_JRI),
           
           # If we expect further reductions from targeted intervention
           In.state = In.state - (In.state * recid_reduction_ovr_cntrl)) %>% 
    
    # Now turn the data into P(relapse | t)
    mutate(cumulative_percent = In.state / 100,
           cumulative_prob_did_not = 1 - cumulative_percent,
           prob_recidivate = 1 - cumulative_prob_did_not / lag(cumulative_prob_did_not),
           prob_did_not_recidivate = 1 - prob_recidivate) %>% 
    filter(In.state != 0) %>% 
    select(prob_recidivate, prob_did_not_recidivate)
}
```




```{r single agent function, echo=FALSE}
sim_single_agent <- function(months,parole_cost_type) {
  
  # Define some factors
  levels.crimetype <- factor(prison_terms$offense_type)
  
  # set up the data frame
  df <- data.frame(month=numeric(0),
                   year=numeric(0),
                   months_free=numeric(0),
                   rearrested_or_not=numeric(0),
                   prison_sentence=numeric(0),
                   crime_type=factor(levels = levels.crimetype),
                   is_in_prison=numeric(0),
                   is_on_parole=numeric(0),
                   parole_sentence=numeric(0),
                   marginal_prison_costs=numeric(0),
                   total_prison_costs=numeric(0),
                   total_court_costs=numeric(0),
                   total_policing_costs=numeric(0),
                   total_combined_costs=numeric(0),
                   total_parole_costs=numeric(0)
                   )
  
  #Combined cost(Emergency room & DWS+DHS & Shelters)
  m.total_combined_costs<-calc_combined_cost(parole_cost_type)
  
  # loop through each month and see what happens			
  for (month in 1:months) {
    
    ### generate action for each month ###
    m.month <- month
    
    ### year
    m.year <- ceiling(m.month / 12)
    
    # Dependent on whether they were arrested or not
    m.months_free <- calc_months_free(m.month, m.prison_sentence, tmp.months_free)
    
    # Binary variable based on the conditional probability table from nationwide trends
    m.rearrested_or_not <- calc_odds_of_being_rearrested(m.months_free)
  
    
    # Add a crime and prison sentence if there was an arrest
    # Also based on probability table from national trends
    crime_and_time <- 
      define_crime_and_time(m.is_on_parole, m.rearrested_or_not, m.month, tmp.prison_sentence)
    
    m.prison_sentence <- as.numeric(crime_and_time[2])
    
    m.crime_type <- as.character(crime_and_time[1])
  
    
    # For calculating the total months in prison later
    m.is_in_prison <- say_if_in_prison(m.prison_sentence)
    
    # And a parole sentence for when they get out
    m.parole_sentence <- calc_parole_sentence(m.month, m.rearrested_or_not, tmp.parole_sentence)
    
    # Is on parole??
    m.is_on_parole <- if_else(m.is_in_prison == 1, 0,
                              ifelse(m.months_free <= m.parole_sentence, 1, 0))
    
    ### Costs of crimes commited
    # Prison
    m.marginal_prison_costs <- calc_marginal_prison_costs(m.is_in_prison, m.month)
    m.total_prison_costs <- calc_total_prison_costs(m.is_in_prison)
    
    # Courts
    m.total_court_costs <- calc_total_court_costs(m.rearrested_or_not, m.crime_type)
    
    # Cops
    m.total_policing_costs <- calc_total_policing_costs(m.rearrested_or_not, m.crime_type)
    
    # Parole
    m.total_parole_costs <- calc_total_app_costs(m.is_on_parole)
    
    # add month to the data frame
    df[month,] <- 
      c(m.month, m.year, m.months_free, m.rearrested_or_not, m.prison_sentence, 
        m.crime_type, m.is_in_prison, m.is_on_parole, m.parole_sentence, 
        m.marginal_prison_costs, m.total_prison_costs, m.total_court_costs, 
        m.total_policing_costs, m.total_combined_costs,
        m.total_parole_costs)
    
    
    # Make temporary vector for determining months free in the next pass
    tmp.months_free <- if_else(m.rearrested_or_not == 1, 0, m.months_free)
    
    # Temporary parole sentence
    tmp.parole_sentence <- m.parole_sentence
    tmp.is_on_parole <- m.is_on_parole
    
    # Also, count down the time served from last month, if any
    tmp.prison_sentence <- ifelse(m.prison_sentence == 0, 0,
                                  m.prison_sentence - 1)
  }
  
  # output results
  return (df)
}


```




```{r multi-agent function, echo=FALSE}
sim_multi_agents <- function(n_agents, n_months,parole_cost_type){
  
  # set up the data frame
  df <- data.frame(prison_time=numeric(0),
                   avg_prison_time_per_yr=numeric(0),
                   months_free=numeric(0),
                   total_prison_costs=numeric(0),
                   avg_prison_cost_per_yr=numeric(0),
                   median_prison_cost_per_yr=numeric(0),
                   prison_cost_yr_one=numeric(0),
                   arrests=numeric(0),
                   total_costs=numeric(0),
                   avg_total_cost_per_yr=numeric(0),
                   median_total_cost_per_yr=numeric(0),
                   avg_other_cost_per_yr=numeric(0),
                   avg_combined_cost_per_yr=numeric(0),
                   avg_parole_cost_per_yr=numeric(0))
  
  # loop through each month and see what happens			
  for (agent in 1:n_agents) {
    
    ### generate action for each person ###
    single_agent <- sim_single_agent(n_months,parole_cost_type)
    
    # Get total costs df
    total_costs_df <- single_agent %>% 
      select(starts_with("total"))
    # Make numeric
    total_costs_df[] <- lapply(total_costs_df, as.numeric) 
    # Get a total column
    total_costs_df$total <- rowSums(total_costs_df)
    
    # Add it back in and remove the df
    single_agent$total_costs <- total_costs_df$total
    rm(total_costs_df)
    
    ### And a summary table for each year ###
    by_year <- single_agent %>% 
      group_by(year) %>% 
      summarise(total_prison_costs = sum(as.numeric(total_prison_costs)),
                total_costs = sum(as.numeric(total_costs)),
                total_prison_time = sum(as.numeric(is_in_prison)),
                total_combined_costs=sum(as.numeric(total_combined_costs)),
                total_parole_costs=sum(as.numeric(total_parole_costs))) %>% 
      mutate(total_other_costs = total_costs - total_prison_costs)
    
    # Sum things that happend to the agent
    a.prison_time <- sum(as.numeric(single_agent$is_in_prison))
    a.avg_prison_time_per_yr <- mean(by_year$total_prison_time)
    a.months_free <- 60 - a.prison_time
    a.total_prison_costs <- sum(by_year$total_prison_costs)
    a.avg_prison_cost_per_yr <- mean(by_year$total_prison_costs)
    a.median_prison_cost_per_yr <- median(by_year$total_prison_costs)
    a.prison_cost_yr_one <- by_year$total_prison_costs[1]
    a.arrests <- sum(as.numeric(single_agent$rearrested_or_not))
    a.total_costs <- sum(by_year$total_costs)
    a.avg_total_cost_per_yr <- mean(by_year$total_costs)
    a.median_total_cost_per_yr <- median(by_year$total_costs)
    a.avg_other_cost_per_yr <- mean(by_year$total_other_costs)
    a.avg_combined_cost_per_yr<-mean(by_year$total_combined_costs)
    a.avg_parole_cost_per_yr<-mean(by_year$total_parole_costs)
    
    # add month to the data frame
    df[agent,] <- 
      c(a.prison_time, a.avg_prison_time_per_yr, a.months_free, a.total_prison_costs, 
        a.avg_prison_cost_per_yr, a.median_prison_cost_per_yr, a.prison_cost_yr_one,
        a.arrests, a.total_costs, a.avg_total_cost_per_yr, a.median_total_cost_per_yr,
        a.avg_other_cost_per_yr,a.avg_combined_cost_per_yr,a.avg_parole_cost_per_yr)
    
  }
  
  
  # output results
  return (df)
  
}
```




```{r model parameters, echo=FALSE}
n_agents = 6000
n_months = 60
```




```{r single-agent pre, echo=FALSE}
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = 0)
single_agent_test <- sim_single_agent(months = n_months,"base") 
```




```{r multi-agent pre, echo=FALSE}
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = 0)
multi_agent <- sim_multi_agents(n_agents = n_agents, n_months = n_months,"base")
```

```{r multi-agent pre_low, echo=FALSE}
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = 0.05)
multi_agent_low <- sim_multi_agents(n_agents = n_agents, n_months = n_months,"low")
```

```{r multi-agent pre_Med, echo=FALSE}
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = 0.15)
multi_agent_med <- sim_multi_agents(n_agents = n_agents, n_months = n_months,"med")
```

```{r multi-agent pre_High, echo=FALSE}
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = 0.25)
multi_agent_high <- sim_multi_agents(n_agents = n_agents, n_months = n_months,"high")
```




```{r analysis of pre, echo=FALSE, include=FALSE}
# Give some analysis to the distribution of spending on the pre category

summary(multi_agent)

multi_agent$cost_quantile <- rank(multi_agent$avg_total_cost_per_yr) / nrow(multi_agent)

base_top_fifteen_percent <- multi_agent %>% 
  filter(cost_quantile >= .85)
summary(base_top_fifteen_percent$avg_total_cost_per_yr)

base_middle_seventy <- multi_agent %>% 
  filter(cost_quantile < .85 & cost_quantile > .15)

base_bottom_fifteen <- multi_agent %>% 
  filter(cost_quantile <= .15)
```





```{r more than two, echo=FALSE}
# This is for getting the # who go back more than twice
more_than_two <- multi_agent %>% 
  filter(arrests > 2) %>% 
  nrow()
```




```{r multi-agent post, echo=FALSE}
recid_reduction_post <- .15
survival_rates <- load_survival_data(recid_reduction_ovr_cntrl = recid_reduction_post)
multi_agent_post <- sim_multi_agents(n_agents = n_agents, n_months = n_months,"base")
```




```{r combine pre and post, echo=FALSE}
to_combine_pre <- multi_agent %>% 
  select(avg_prison_cost_per_yr) %>% 
  mutate(Pre_or_Post = "Pre")

combined_pre_po <- multi_agent_post %>% 
  select(avg_prison_cost_per_yr) %>% 
  mutate(Pre_or_Post = "Post") %>% 
  rbind(to_combine_pre)
  
```

<br>
<br>
<br>
<br>
<br>

![](dont_commit/logo.png)


##### Pagebreak

This report describes work done by staff at the [Sorenson Impact Center](http://eccles.utah.edu/sorenson-impact-center/) of the University of Utah to quantify the benefits of a program to reduce recidivism among parolees with with co-occurring mental health and substance use disorders (COD). 

The potential benefits of reducing jail time for the COD population are numerous. The COD population recidivates at a much higher rate than the general population. Almost 75% return within three years of their release. In this report, we focus on the economic benefits of reducing recidivism among members of this group, paying particular attention to prison costs. Data from the Utah Department of Corrections demonstrate that the average prisoner costs the State $81.34 per day, or approximately $30,000 per year. 

To understand these costs, we analyzed recidivism, crime, parole, and taxpayer-funded social services. We rely on data from the Bureau of Justice Statistics, University of Utah, and several divisions of Utah state government, including the Departments of Corrections, Human Services, and the Commission on Criminal and Juvenile Justice.  




### Summary
```{r summary, echo=FALSE}
prison_savings <- mean(multi_agent$avg_prison_cost_per_yr) - mean(multi_agent_med$avg_prison_cost_per_yr)

out_of_prison_savings <- mean(multi_agent$avg_other_cost_per_yr) - mean(multi_agent_med$avg_other_cost_per_yr)
```


To estimate taxpayer savings from the proposed program, we have created three different models of the potential impacts: low, medium, and high, with recidivism reductions of 5%, 15%, and 25%, respectively. The results of each of these is evaluated against an estimated baseline. 

By reducing recidivism among the COD population by 15% (the "medium" scenario), this model estimates that the State can expect gross savings in prison expenditures of approximately `r dollar(round(prison_savings))` per participant per year. These savings would come from direct reductions in prison time for the average participant. 

By providing a higher level of care for the COD population, the State can also expect to see ancillary benefits in the form of reduced crime, shelter days, and outpatient stays, for example. These are more difficult to quantify, but we conservatively estimate the average savings at `r dollar(round(out_of_prison_savings))`, for total gross savings of **`r dollar(round(prison_savings + out_of_prison_savings))`** per participant per year.  

The table below shows the results from each of the three models:


```{r cost table, echo=FALSE}
# Create a table of low, mediumm, and high cost estimates. 
table<-data_frame(c("Base","Low","Medium","High"),
                 
                  
c(dollar(round(mean(multi_agent$avg_other_cost_per_yr))),
                    dollar(round(mean(multi_agent_low$avg_other_cost_per_yr))),
                    dollar(round(mean(multi_agent_med$avg_other_cost_per_yr))),
                    dollar(round(mean(multi_agent_high$avg_other_cost_per_yr)))),  

c(dollar(round(mean(multi_agent$avg_prison_cost_per_yr))),
                    dollar(round(mean(multi_agent_low$avg_prison_cost_per_yr))),
                    dollar(round(mean(multi_agent_med$avg_prison_cost_per_yr))),
                    dollar(round(mean(multi_agent_high$avg_prison_cost_per_yr)))),

c(dollar(round(mean(multi_agent$avg_total_cost_per_yr))),
                    dollar(round(mean(multi_agent_low$avg_total_cost_per_yr))),
                    dollar(round(mean(multi_agent_med$avg_total_cost_per_yr))),
                    dollar(round(mean(multi_agent_high$avg_total_cost_per_yr))))
                  )
colnames(table)<-c("Model","Out of Prison Cost per Year",
                   "Prison Cost per Year","Total Cost per Year")
kable(head(table,10),digits=4,align = 'c')

```

Out of Prison Costs can be broken down into the cost of parole, extraneous costs while being on parole, and costs associated with being sent to prison such as policing and court costs. The cost of putting someone on parole is on average `r dollar(round(mean(multi_agent$avg_parole_cost_per_yr)))` per person per year. The policing and court costs only represent about `r round(((mean(multi_agent$avg_other_cost_per_yr)
-mean(multi_agent$avg_combined_cost_per_yr)-mean(multi_agent$avg_parole_cost_per_yr))/mean(multi_agent$avg_other_cost_per_yr))*100)` % of Out of Prison costs. So these two categories only represent a cumulative 
`r round(((mean(multi_agent$avg_other_cost_per_yr)
-mean(multi_agent$avg_combined_cost_per_yr))/mean(multi_agent$avg_other_cost_per_yr))*100)`% of Out of Prison costs and do not vary very much as we reduce cost and recidivism.The largest potential to reduce cost is in the second category. Costs not associated with actually being put on parole such as medical care and shelter visits represent the majority of cost at 
`r dollar(round(mean(multi_agent$avg_combined_cost_per_yr)))` out of
`r dollar(round(mean(multi_agent$avg_other_cost_per_yr)))` per person per year, but also have the largest deviation as some parolees will have fairly low costs and a small few will be super utilizers. Removal of a few outliers in this category can greatly reduce the average out of prison cost.
The following table shows how each recidivism reduction model affects these particular costs. When compared to the previous table these extraneous costs represent the vast majority of the reduction of cost. 

```{r parole cost table, echo=FALSE}
# Create a table of low, mediumm, and high cost estimates. 
table<-data_frame(c("Base","Low","Medium","High"),
                 
                  
c(dollar(round(mean(multi_agent$avg_combined_cost_per_yr))),
                    dollar(round(mean(multi_agent_low$avg_combined_cost_per_yr))),
                    dollar(round(mean(multi_agent_med$avg_combined_cost_per_yr))),
                    dollar(round(mean(multi_agent_high$avg_combined_cost_per_yr))))  
 )
colnames(table)<-c("Model","Extraneous Costs on Parole")
kable(head(table,10),digits=4,align = 'c')

```

##### Pagebreak 

The table above shows the estimated taxpayer savings from the three scenarios. The following table shows the potential benefits of the program for the participants themselves. Even a small reduction in recidivism will lead to significantly less prison time for the average parolee.    

```{r prison time, echo=FALSE}
# Create a table of low, mediumm, and high cost estimates. 
table<-data_frame(c("Base","Low","Medium","High"),
 c("0%","5%","15%","25%") ,               
                  
c(round(mean(multi_agent$avg_prison_time_per_yr * 30.5)),
                    round(mean(multi_agent_low$avg_prison_time_per_yr * 30.5)),
                    round(mean(multi_agent_med$avg_prison_time_per_yr * 30.5)),
                    round(mean(multi_agent_high$avg_prison_time_per_yr * 30.5))),

c(round(median(multi_agent$avg_prison_time_per_yr * 30.5)),
                    round(median(multi_agent_low$avg_prison_time_per_yr * 30.5)),
                    round(median(multi_agent_med$avg_prison_time_per_yr * 30.5)),
                    round(median(multi_agent_high$avg_prison_time_per_yr * 30.5)))
)

colnames(table)<-c("Model",
                   "Recidivism Reduction",
                   "Average Days in Prison per Year",
                   "Median Days in Prison per Year")
kable(head(table,10),digits=3,align = 'c')

```


There are several other indirect benefits, which we do not explore in this report, e.g., reductions in victim costs, or improvements in job prospects for the COD group. We hope that a pilot program will help to better define the potential costs and benefits of providing intense support to this population. 




##### Pagebreak

# Recidivism Rates

## Description:
This is the estimated percent of parolees who will return to prison within a given time after release. 


## Sources:
The kaplan-meier curves come from the Bureau of Justice Statistics, which compiles [national trends](http://www.bjs.gov/index.cfm?ty=pbdetail&iid=4986) on recidivism. The Utah Department of Corrections also provided recidivism rates for the 2012 release cohort, which allowed for tracking of the COD population over three years. Numbers from the pre-JRI period suggest that Utah is similar to national trends.


## Assumptions:
[It is worth noting that we can test the sensitivity of the model to these or any other assumptions described in this document]

* We assume that survival curves for the COD population will bend in similar ways to national trends
* Conservatively, we estimate that the JRI will reduce recidivism among the COD population by `r percent(recid_reduction_JRI)`. Data do not yet exist for Utah's recidivism rates post-JRI, so this estimate is based on conversations with those familiar with the reforms.  


## Statistics
* Pre-JRI, approximately `r percent(round(sr_study_group$cumulative_percent[12], 2))` of the COD population re-offended within one year.
* Approximately `r percent(round(sr_study_group$cumulative_percent[36], 2))` re-offended within three years.
* If, as this model assumes, the JRI reduces recidivism by `r percent(recid_reduction_JRI)`, there will still be `r percent(round(sr_post_intervention$cumulative_percent[36], 2))` of the COD population who recidivate within three years.


##### Pagebreak
The following chart shows estimated survival curves from national averages, the COD population pre-JRI, and post-JRI with a `r percent(recid_reduction_JRI)` reduction in recidivism. The X-axis is time in months over a period of five years. The Y-axis is the cumulative percent who recidivate at least once. The chart shows that recidivism is more likely in the first year, and then tapers off over time. This suggests that if a program is effective at helping people early on, it will be more effective than if it aims to help people several months removed from their release.   

```{r pressure, echo=FALSE}
# plot the curves
ggplot(all_together, aes(months)) + 
  geom_line(aes(y = sr_post_intervention.cumulative_percent, colour = "COD Post-JRI")) + 
  geom_line(aes(y = sr_study_group.cumulative_percent, colour = "COD Group")) +
  geom_line(aes(y = sr_baseline.cumulative_percent, colour = "National Trend")) +
  labs(title = "Time to Recidivism", y = "Percent Who Recidivate") + 
  scale_y_continuous(labels=percent)

# And clean things up
rm(all_together, sr_post_intervention, sr_study_group, sr_baseline)
```


##### Pagebreak


# Crime Types

## Description:
These data show the frequency of certain crime types among parolees. They differ from the survival curves in that they show not the time it takes to reoffend, but what type of crime is most likely to be involved in the event of a re-offense.  


## Sources:
Data on crime frequencies come from the Department of Corrections, which provided counts for the COD demographic. These data indicate that for the 2012 cohort, nearly 70% of prison returns were for a technical violation. This is slightly higher than for the general prison population, according to a report by the [CCJJ](http://justice.utah.gov/Documents/CCJJ/Reports/Justice_Reinvestment_Report_2014.pdf). 

Data on the courts and policing costs of various crimes come from a report by the CCJJ and faculty at the University of Utah titled [Utah Cost of Crime Report : Introduction to an Econometric Cost-Benefit Approach](http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf).    


## Assumptions:
* The crime type frequencies for a re-offense will be similar to those from the original offense.
* The Cost of Crime report did not include costs for a parole violation. This model assume those costs are similar to the costs of a property crime.  


## Statistics
* Property crimes are the most likely type of crime, at `r percent(round(prison_terms$frequency_of_crime[prison_terms$offense_type == "Property"], 2))` of all crimes committed while off parole. It is also the least expensive at `r dollar(round((prison_terms$court_cost[prison_terms$offense_type == "Property"] + prison_terms$police_cost[prison_terms$offense_type == "Property"]), 2))` (court and policing costs).
* Murder is the least likely, at less than `r percent(round(prison_terms$frequency_of_crime[prison_terms$offense_type == "Murder"], 2))`, but the most expensive by far at `r dollar(round((prison_terms$court_cost[prison_terms$offense_type == "Murder"] + prison_terms$police_cost[prison_terms$offense_type == "Murder"]), 2))`
* When on parole, the most likely reason to be sent back is for a technical violation. These account for about `r percent(round(prison_terms$frequency[prison_terms$offense_type == "Parole_Violation"], 2))` of recidivism occurrences. 

The following table shows these frequencies and costs (for court and policing).

```{r, echo=FALSE}

frequenceis_to_print <- prison_terms %>% 
  mutate(cost = dollar(police_cost + court_cost)) %>% 
  select(offense_type, frequency, frequency_of_crime, cost) %>% 
  filter(offense_type != "") %>% 
  mutate("off parole" = percent(frequency_of_crime),
         "on parole" = percent(frequency)) %>% 
  select(-frequency, -frequency_of_crime)

kable(head(frequenceis_to_print, 10), digits = 3)

rm(frequenceis_to_print)
```



##### Pagebreak


# Prison Time Served

## Description:
If convicted, these data show the length of time a parolee can expect to spend in prison, on average, for the various crime types. 


## Sources:
The [2014 Justice Reinvestment Report](http://justice.utah.gov/Documents/CCJJ/Reports/Justice_Reinvestment_Report_2014.pdf) and [ACLU Report](http://www.acluutah.org/criminal-justice/item/download/15_0cfccf37c91e9fb16be4ac2e89ca12f2) contain the mean time served for various offenses, which we scale down to reflect changes from the JRI (as described below). 


## Assumptions:
* We conservatively assume that the JRI will reduce the mean prison time served by about `r percent(1 - time_served_scale_JRI)` for all crime types. Data do not yet exist for Utah's prison sentences post-JRI, so this estimate is based on conversations with people familiar with the reforms. 
* This model assumes that the average prison sentence for technical violations will go from 15 months to approximately `r parole_violation_MTS_JRI` months. This estimate is based on the new [sentencing guidelines](http://www.utah.gov/pmn/files/172049.pdf).
* It also assumes that average parole sentence will go from three years to `r parole_length_JRI` months for those who exhibit good behavior, which is stipulated in the [earned-time credit program](http://corrections.utah.gov/index.php?option=com_content&view=category&id=31&Itemid=344). 


## Statistics
* Murder resulted in the longest average prison sentence at `r prison_terms$mean_time_served[prison_terms$offense_type == "Murder"]` months.
* The second longest was for sex crimes: `r prison_terms$mean_time_served[prison_terms$offense_type == "Sex"]` months.

Here is a table of the actual values and the estimated values for the post-JRI period.

```{r, echo=FALSE}

mts_to_print <- prison_terms %>%
  filter(offense_type != "") %>% 
  mutate("offense type" = offense_type, "mean time served" = mean_time_served,
         "estimated MTS post-JRI" = mean_time_served_post_JRI) %>% 
  select(-offense_type:-mean_time_served_post_JRI)  
   

kable(head(mts_to_print, 10), digits = 3)

rm(mts_to_print)

```




##### Pagebreak

# Costs

## Description:
These are assumptions, estimates, and past data about the direct taxpayer costs of caring for a parolee both in and out of prison.  


## Sources:
As described above, [Utah's Cost of Crime](http://www.justice.utah.gov/Documents/CCJJ/Cost%20of%20Crime/Utah%20Cost%20of%20Crime%202012%20-%20Methods%20Review%20Cost.pdf) report contains estimates of the taxpayer costs of crimes, from which we take the policing and court costs. The costs of prison, parole, and shelters come from two PDF reports given to the Center by the Department of Corrections: one that details the cost per day for prisons, and one for parole services, including costs for Community Correctional Centers (CCC). Aggregated DWS and DHS cost data were given to the Center by the respective agencies.      


## Assumptions:
* Once released, this model assumes a parolee will spend about `r percent(prob_of_shelter)` of his or her time, on average, in a shelter. This is based on data from the state of California, where "10% of the state’s parolees are homeless," according to [the Center for Supportive Housing](http://www.endhomelessness.org/page/-/files/1101_file_Cho_Presentation.pdf).
* Parolees will use DWS services at rates similar to the average childless male who utilizes these services.
* To be conservative, this model estimates that the total DHS spending is $3,000 per parolee per year. (DHS spends about $3,000 annually per client on substance use treatment, and $3,000 per client on mental health services. Even though some of the COD population could be utilizing both types of service, there may also be some who utilize neither).
* This model assume that DWS, DHS, shelter, parole, and other similar costs are only borne by the state when the parolee is out of prison, and that the probability of utilizing these services is not conditional on other variables.
* DHS costs include some inpatient and outpatient care (e.g., methadone). We also assume that the average parolee will visit the ER two times per year, while free, at an average cost of `r dollar(round(ambulance + ER))` per trip.
* This model uses the total average daily cost of prison, which is approximately $81 per prisoner. While some would consider the marginal cost more useful, we feel the total cost is defensible given these two considerations: 1. prisoners with COD likely use more services than average, 2. the State is considering building a new prison, so a significant reduction in the prison population could impact that decision. 



##### Pagebreak

# Results: No Intervention

## Description:
These are the results of running an agent-based simulation `r comma(n_agents)` times with all of the assumptions listed above. 


## Statistics:
* The average total cost per parolee per year was `r dollar(round(mean(multi_agent$avg_total_cost_per_yr)))`, , with a standard deviation of `r dollar(round(sd(multi_agent$avg_total_cost_per_yr)))`.
* The median was `r dollar(round(median(multi_agent$avg_total_cost_per_yr)))`.
* The maximum annual taxpayer cost in this simulation was `r dollar(round(max(multi_agent$avg_total_cost_per_yr)))`. This would likely be someone who spent the majority of the 5 years in prison. 
* On the other end are parolees who cost the state less than `r dollar(round(quantile((multi_agent$avg_total_cost_per_yr), .25)))`, which is the bottom quartile of annual costs. This group likely stayed out of prison, or only went back for a brief time period. Their costs are more associated with parole, health benefits, and shelters, in certain cases.
* Prison remains the largest cost factor for parolees. The average simulation resulted in prison costs of `r dollar(round(mean(multi_agent$avg_prison_cost_per_yr)))` per year, or `r percent(mean(multi_agent$avg_prison_cost_per_yr) / mean(multi_agent$avg_total_cost_per_yr))` of the total cost.
* This is because, even accounting for the JRI, the average number of prison days per year for this group was `r round(mean(multi_agent$avg_prison_time_per_yr) * 30.5)`, with a standard deviation of `r round(sd(multi_agent$avg_prison_time_per_yr) * 30.5)`. The median was `r round(median(multi_agent$avg_prison_time_per_yr) * 30.5)`.
* More than half of the COD population will return to prison within 5 years. In fact, many will return multiple times. In these simulations, `r percent(more_than_two / nrow(multi_agent))` returned more than twice:

```{r returns, echo=FALSE, fig.height=2.5}
# plot the hist
ggplot(multi_agent, aes(arrests)) + 
  geom_bar(fill="#c0392b", alpha=0.75, color = "white") +
  ylab("# of Simulations") +
  xlab("# of re-arrests during entire simulation")
```

##### Pagebreak

# Results: Post-Intervention


## Description:
These are the results of running the same model as above, but assuming a recidivism reduction of `r percent(recid_reduction_post)`. 



```{r, echo=FALSE}
y1 <- mean(multi_agent$avg_prison_cost_per_yr)
y2 <- mean(multi_agent_post$avg_prison_cost_per_yr)
```
## Statistics:
* Average annual prison costs are reduced from `r dollar(round(y1))` to `r dollar(round(y2))`, which is a reduction of `r dollar(round(y1 - y2))`, or `r percent((y2 - y1) / y1)`.
* The average number of prison days per year for this group was `r round(mean(multi_agent_post$avg_prison_time_per_yr) * 30.5)`, with a standard deviation of `r round(sd(multi_agent$avg_prison_time_per_yr) * 30.5)`.
* The most significant reduction is in the median prison days per year. In the first simulation of the COD group (with no intervention), the median was `r round(mean(multi_agent$avg_prison_time_per_yr) * 30.5)`. In the simulation of the COD group post-treatment, that reduced to `r round(median(multi_agent_post$avg_prison_time_per_yr) * 30.5)` prison days per year.
* This is partially because reducing recidivism by `r percent(recid_reduction_post)` will ensure that a much larger portion of parolees will avoid prison.  

```{r returns_post, echo=FALSE, fig.height=2.5}
# plot the hist
ggplot(multi_agent_post, aes(arrests)) + 
  geom_bar(fill="#c0392b", alpha=0.75, color = "white") +
  ylab("# of Simulations") +
  xlab("# of re-arrests during entire simulation")
```



##### Pagebreak


# Results: Summary
As described above, by reducing recidivism by `r percent(recid_reduction_post)`, this model projects that the average annual prison costs for the COD group would be reduced by `r dollar(round(y1 - y2))`, or `r percent((y2 - y1) / y1)`. Here is a chart of the distributions of the prison costs pre and post, for comparison.

```{r cdf, echo=FALSE}
# plot the hist
ggplot(combined_pre_po, aes(x = avg_prison_cost_per_yr, fill = Pre_or_Post)) + geom_density(alpha = 0.5) +
  labs(title = "Density Plot of Annual Prison Costs", y = "% of Simulations", x = "Average Prison Cost Per Year") +
  scale_x_continuous(labels=dollar) + scale_y_continuous(labels = percent)
```


### Bottom Line
So far, this report has examined only the cost savings of reductions in prison time. Presumably, by providing a higher level of care for the COD population, the State can also expect to see ancillary benefits. For example, if this treatment reduced costs other than ones associated with prison by `r percent(recid_reduction_post)`, there would be additional annual savings of `r dollar(round(recid_reduction_post * mean(multi_agent_post$avg_other_cost_per_yr)))` per parolee.

Given these assumptions, we estimate that a program that reduces recidivism by `r percent(recid_reduction_post)` could lead to gross savings of approximately $3,500 per year, per parolee. 


##### Pagebreak

```{r, echo=FALSE}
sensitivity_recid_reductions <- c(.05, .1, .15, .2, .25, .3, .35, .4)
sensitivity_vector <- c()
for (i in sensitivity_recid_reductions) {
  survival_rates <- load_survival_data(i)
  multi_agent_post <- sim_multi_agents(n_agents = 10, n_months = 60,"base")
  m <- mean(multi_agent_post$avg_prison_cost_per_yr)
  sensitivity_vector <- append(sensitivity_vector, m)
}
```

# Results: Sensitivity Analysis
As described above, the main purpose of this model is to estimate the savings in prison costs as a function of recidivism rates. The following table shows the approximate relationship between a reduction in recidivism and the expected prison costs per parolee. What this shows is that on average, a 5% reduction in recidivism should lead to approximate cost savings of $470 per parolee per year (considering only the prison costs). 

```{r, echo=FALSE}
sensitivity_df <- data.frame(sensitivity_vector, sensitivity_recid_reductions)

sensitivity_df_to_print <- sensitivity_df %>%
  mutate("recidivism reduction" = percent(sensitivity_recid_reductions), "prison costs per parolee" = dollar(sensitivity_vector)) %>% 
  select(-sensitivity_vector, -sensitivity_recid_reductions)
        
kable(head(sensitivity_df_to_print), digits = 3)

rm(sensitivity_df_to_print)
```

The plot does a better job of showing the relationship. It is easier to see that larger savings are to be had on the first 5% to 15% reductions in recidivism, with smaller relative savings on reductions above that. 

```{r, echo=FALSE, fig.height=2.5}
ggplot(sensitivity_df, aes(x = sensitivity_recid_reductions, y = sensitivity_vector)) + geom_point() + labs(title = "Scatter Plot of Sensitivity Analysis", y = "Expected Prison Costs", x = "Recidivism Reduction") +
  scale_x_continuous(labels=percent) + scale_y_continuous(labels = dollar)
```


##### Pagebreak
# Appendix : About the model

## Description:

The process outlined below falls within a broad category called [agent-based modeling](https://en.wikipedia.org/wiki/Agent-based_model) (ABM), which wikipedia defines as "computational models for simulating the actions and interactions of autonomous agents with a view to assessing their effects on the system as a whole."

1. Simulate a single agent for five years from the time he or she leaves prison. Each agent may return to prison immediately, or stay out of prison for the entire 60 months. The odds of these events are based on real data and are stochastic in the sense that they are not predetermined.
2. Repeat this simulation thousands of times to see how the results vary.  


The first step in this process is to turn data from the survival curves into an estimate of a parolee's odds of recidivating in a given month. The conditional probability of continued freedom is given by:  

$$P_i = \frac{f_i - r_i}{f_i}$$

where *f* is the number of people free but at risk of recidivating in the *i*th interval, and *r* is the number who recidivated in the same period.  


When loaded with no treatment assumed, the first five rows of data look like this:

```{r, echo=FALSE}
survival_rates_for_printing <- load_survival_data(0) %>% 
  mutate(month = seq(1:nrow(.))) %>% 
  mutate(prob_recidivate = percent(prob_recidivate),
         prob_did_not_recidivate = percent(prob_did_not_recidivate))

kable(head(survival_rates_for_printing[,c(3,1,2)], 5), digits = 3)

rm(survival_rates_for_printing)
```

These estimates show that in the first month, someone from the COD group has about an 8% chance of recidivating. But if he can make it 4 months, that drops to only 5% in month 5. Using these data, we are now ready to populate our model.



##### Pagebreak


## Assumptions:
* It is advisable to look at average costs over the course of `r n_months / 12` years with a sample of `r comma(n_agents)` simulated agents. Shorter time frames with fewer simulations may lead to anomalous results.
 

### Single Agent 
When run for a single person, the resulting data contain `r n_months` rows, each representing a month in the life of the simulated parolee. The columns track outcomes of the simulation and their associated costs: `r names(single_agent_test)`. 

The main driver of costs and savings is prison time, which is represented by a binary [0,1] variable, where 1 means "in prison." For a single agent, that could be represented in the following chart, where the X-axis is time in months, and the Y-axis is prison status:

```{r, echo=FALSE}
# Prep data
single_agent_test$month <- as.numeric(single_agent_test$month)
ggplot(single_agent_test, aes(month, is_in_prison, group = 1)) + 
  geom_line() + labs(title = "Single Agent Simulation", y = "prison status")
```


##### Pagebreak

## Multiple Agent Simulation
The power of this model comes from tracking the outcomes of multiple simulations. For each one, we track time in and out of prison and the associated costs. This allows us to answer the question of what would happen if we reduced recidivsm among the COD population. To help visualize this, here is a matrix of 12 simulations using the same chart format from the previous page:  

```{r multiple plots, echo=FALSE}
# First a function to plot multiple plots in one
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

plots <- list()  # new empty list
for (i in 1:12) {
  single_agent_test <- sim_single_agent(months = n_months,"base")
  single_agent_test$month <- as.numeric(single_agent_test$month)
  p1 = ggplot(single_agent_test, aes(month, is_in_prison, group = 1)) + 
  geom_line() + labs(y = "", x = "")
  plots[[i]] <- p1  # add each plot into plot list
}
multiplot(plotlist = plots, cols = 4)
```

Instead of 12, however, the final model will perform `r comma(n_agents)` simulations, summing prison time, parole, and all of the costs measured for each individual simulation.  

A portion of these will always remain flat - meaning the person will stay out of prison for the entire 5 years. For the remainder of parolees who recidivate, some will go in and out quickly on technical violations, while others will commit serious crimes and stay in for longer sentences.  


